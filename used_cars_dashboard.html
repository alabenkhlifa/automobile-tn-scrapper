<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tunisia Used Cars Dashboard - automobile.tn</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-datalabels/2.2.0/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
    tailwind.config = {
        theme: {
            fontFamily: {
                sans: ["'Segoe UI'", 'Tahoma', 'Geneva', 'Verdana', 'sans-serif']
            }
        }
    }
    </script>
    <style type="text/tailwindcss">
        body { @apply font-sans bg-slate-900 text-slate-50 min-h-screen p-2.5 md:p-5; }
        .container { @apply max-w-[1600px] mx-auto; }

        header { @apply text-center mb-5 md:mb-10 py-5 px-4 md:p-8 bg-slate-800 rounded-2xl border border-white/10 relative; }

        .lang-toggle {
            @apply relative md:absolute md:top-5 md:right-5 flex bg-slate-700 rounded-lg overflow-hidden border border-white/10 w-fit mx-auto md:mx-0 mb-2.5 md:mb-0;
        }
        .lang-toggle button {
            @apply py-2 px-4 border-none bg-transparent text-slate-400 cursor-pointer text-sm font-medium transition-all duration-200;
        }
        .lang-toggle button:hover { @apply bg-white/5; }
        .lang-toggle button.active { @apply bg-blue-500 text-slate-50; }

        header h1 {
            @apply text-2xl md:text-4xl font-bold mb-2.5 bg-clip-text bg-gradient-to-br from-[#f093fb] to-[#f5576c];
            -webkit-text-fill-color: transparent;
        }
        header p { @apply text-slate-400 text-sm md:text-lg; }

        .stats-grid { @apply grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-2.5 md:gap-5 mb-5 md:mb-8; }
        .stat-card {
            @apply bg-slate-800 rounded-2xl p-3.5 md:p-6 border border-white/10 transition-all duration-300 hover:-translate-y-1 hover:shadow-[0_20px_40px_rgba(0,0,0,0.3)];
        }
        .stat-card.gradient-1 { @apply border-l-4 border-l-[#667eea]; }
        .stat-card.gradient-2 { @apply border-l-4 border-l-[#f5576c]; }
        .stat-card.gradient-3 { @apply border-l-4 border-l-[#4facfe]; }
        .stat-card.gradient-4 { @apply border-l-4 border-l-[#43e97b]; }
        .stat-card.gradient-5 { @apply border-l-4 border-l-[#fa709a]; }
        .stat-card.gradient-6 { @apply border-l-4 border-l-amber-500; }
        .stat-card h3 { @apply text-slate-400 text-[0.7rem] md:text-[0.85rem] uppercase tracking-widest mb-2; }
        .stat-card .value { @apply text-xl md:text-[2rem] font-bold mb-1; }
        .stat-card .subtitle { @apply text-slate-400 text-xs md:text-sm; }

        .charts-grid { @apply grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6 mb-5 md:mb-8; }
        .chart-card { @apply bg-slate-800 rounded-2xl p-4 md:p-6 border border-white/10; }
        .chart-card.full-width { @apply lg:col-span-2; }
        .chart-card h2 {
            @apply text-base md:text-xl mb-3 md:mb-5 text-slate-50 flex items-center gap-2.5;
        }
        .chart-card h2::before {
            content: '';
            @apply w-1 h-5 rounded-sm block shrink-0;
            background: linear-gradient(135deg, #f093fb, #f5576c);
        }

        .chart-container { @apply relative h-[250px] md:h-[300px]; }
        .chart-container.tall { @apply h-[300px] md:h-[400px]; }

        .table-container { @apply overflow-x-auto max-h-[400px]; }
        table { @apply w-full border-collapse; }
        th, td {
            @apply py-2 px-1.5 md:py-3 md:px-4 text-left text-xs md:text-sm;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        th { @apply bg-slate-700 text-slate-400 text-xs uppercase tracking-wider sticky top-0; }
        tr:hover { @apply bg-white/5; }

        .price { @apply font-semibold text-emerald-500 whitespace-nowrap; }
        .mileage { @apply text-amber-500 font-medium; }
        .year { @apply text-cyan-500 font-medium; }

        .badge { @apply inline-block py-1 px-2.5 rounded-full text-xs font-semibold; }
        .badge-essence { background: rgba(249, 115, 22, 0.2); @apply text-orange-500; }
        .badge-diesel { background: rgba(100, 116, 139, 0.2); @apply text-slate-400; }
        .badge-electrique { background: rgba(6, 182, 212, 0.2); @apply text-cyan-500; }
        .badge-hybride { background: rgba(139, 92, 246, 0.2); @apply text-violet-500; }
        .badge-automatique { background: rgba(59, 130, 246, 0.2); @apply text-blue-500; }
        .badge-manuelle { background: rgba(250, 204, 21, 0.2); @apply text-yellow-300; }
        .badge-suv { background: rgba(16, 185, 129, 0.2); @apply text-emerald-500; }
        .badge-berline { background: rgba(99, 102, 241, 0.2); @apply text-indigo-400; }
        .badge-citadine { background: rgba(236, 72, 153, 0.2); @apply text-pink-500; }
        .badge-compacte { background: rgba(20, 184, 166, 0.2); @apply text-teal-500; }
        .badge-break { background: rgba(168, 85, 247, 0.2); @apply text-purple-400; }
        .badge-coupe { background: rgba(239, 68, 68, 0.2); @apply text-red-500; }
        .badge-cabriolet { background: rgba(251, 146, 60, 0.2); @apply text-orange-400; }
        .badge-monospace { background: rgba(34, 197, 94, 0.2); @apply text-green-500; }
        .badge-pick-up { background: rgba(120, 113, 108, 0.2); @apply text-stone-400; }
        .badge-utilitaire { background: rgba(107, 114, 128, 0.2); @apply text-gray-400; }
        .badge-default { background: rgba(148, 163, 184, 0.2); @apply text-slate-400; }
        .badge-condition-tres-bon { background: rgba(16, 185, 129, 0.2); @apply text-emerald-500; }
        .badge-condition-bon { background: rgba(59, 130, 246, 0.2); @apply text-blue-500; }
        .badge-condition-normal { background: rgba(148, 163, 184, 0.2); @apply text-slate-400; }

        .loading { @apply text-center py-16 text-slate-400; }
        .loading::after {
            content: '';
            @apply inline-block w-8 h-8 rounded-full animate-spin ml-4 align-middle;
            border: 3px solid #334155;
            border-top-color: #3b82f6;
        }

        .error { @apply bg-red-500/20 border border-red-500 p-5 rounded-xl text-center text-red-500; }
        footer { @apply text-center py-5 md:py-8 px-2.5 text-slate-400 text-xs md:text-sm; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="lang-toggle">
                <button id="lang-en" onclick="setLanguage('en')">EN</button>
                <button id="lang-fr" class="active" onclick="setLanguage('fr')">FR</button>
            </div>
            <h1 id="header-title">Tableau de Bord Voitures d'Occasion Tunisie</h1>
            <p id="header-subtitle">Analyses en temps réel du marché automobile.tn</p>
        </header>

        <div id="content">
            <div class="loading" id="loading-text">Chargement des données...</div>
        </div>

        <footer>
            Données extraites de automobile.tn | Tableau de bord généré automatiquement
        </footer>
    </div>

    <script>
        // Chart.js global configuration
        Chart.defaults.color = '#94a3b8';
        Chart.defaults.borderColor = 'rgba(255,255,255,0.1)';
        Chart.defaults.font.family = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";

        // Language management
        let currentLang = localStorage.getItem('dashboardLang') || 'fr';
        let cachedData = null;
        let chartInstances = {};

        const translations = {
            en: {
                headerTitle: "Tunisia Used Cars Dashboard",
                headerSubtitle: "Real-time analytics from automobile.tn marketplace",
                footerText: "Data scraped from automobile.tn | Dashboard generated automatically",

                // Stat cards
                totalListings: "Total Listings",
                totalListingsSubtitle: "used cars available",
                brands: "Brands",
                brandsSubtitle: "manufacturers",
                averagePrice: "Average Price",
                averagePriceSubtitle: "market average",
                avgMileage: "Average Mileage",
                avgMileageSubtitle: "kilometers driven",
                avgAge: "Average Age",
                avgAgeSubtitle: "years old",

                // Chart titles
                priceDistribution: "Price Distribution",
                priceVsAge: "Price vs Age",
                topExpensive: "Top 10 Most Expensive",
                bestDeals: "Newest Cars at Best Prices",
                fuelTypes: "Fuel Types",
                transmissionTypes: "Transmission Types",
                bodyTypes: "Body Types",
                topBrands: "Top 15 Brands",
                ageDistribution: "Vehicle Age Distribution",
                mileageDistribution: "Mileage Distribution",
                ownershipHistory: "Ownership History",
                conditionDistribution: "Vehicle Condition",
                geographicDistribution: "Listings by Governorate",
                commonEquipment: "Most Common Equipment",

                // Labels
                numberOfCars: "Number of Cars",
                price: "Price",
                age: "Age (years)",
                mileage: "Mileage",
                cars: "Cars",
                firstHand: "1st hand",
                secondHand: "2nd hand",
                thirdPlus: "3rd+ hand",
                unknown: "Unknown",
                rank: "#",
                car: "Car",
                year: "Year",
                fuel: "Fuel",
                transmission: "Transmission",
                type: "Type",
                cvFiscal: "CV Fiscal",
                governorate: "Governorate",
                condition: "Condition",

                // Price buckets
                under30k: "< 30K",
                range30to50k: "30-50K",
                range50to80k: "50-80K",
                range80to120k: "80-120K",
                range120to200k: "120-200K",
                over200k: "> 200K",

                // Mileage buckets
                under50k: "< 50K km",
                range50to100k: "50-100K km",
                range100to150k: "100-150K km",
                range150to200k: "150-200K km",
                over200kKm: "> 200K km",

                loading: "Loading data...",
                errorTitle: "Error Loading Data",
                errorHelp: "Please run the scraper first:"
            },
            fr: {
                headerTitle: "Tableau de Bord Voitures d'Occasion Tunisie",
                headerSubtitle: "Analyses en temps réel du marché automobile.tn",
                footerText: "Données extraites de automobile.tn | Tableau de bord généré automatiquement",

                // Stat cards
                totalListings: "Total Annonces",
                totalListingsSubtitle: "voitures disponibles",
                brands: "Marques",
                brandsSubtitle: "constructeurs",
                averagePrice: "Prix Moyen",
                averagePriceSubtitle: "moyenne du marché",
                avgMileage: "Kilométrage Moyen",
                avgMileageSubtitle: "kilomètres parcourus",
                avgAge: "Âge Moyen",
                avgAgeSubtitle: "années",

                // Chart titles
                priceDistribution: "Distribution des Prix",
                priceVsAge: "Prix vs Âge",
                topExpensive: "Top 10 Plus Chères",
                bestDeals: "Voitures Récentes aux Meilleurs Prix",
                fuelTypes: "Types de Carburant",
                transmissionTypes: "Types de Transmission",
                bodyTypes: "Types de Carrosserie",
                topBrands: "Top 15 Marques",
                ageDistribution: "Distribution par Âge",
                mileageDistribution: "Distribution du Kilométrage",
                ownershipHistory: "Historique des Propriétaires",
                conditionDistribution: "État des Véhicules",
                geographicDistribution: "Annonces par Gouvernorat",
                commonEquipment: "Équipements les Plus Courants",

                // Labels
                numberOfCars: "Nombre de Voitures",
                price: "Prix",
                age: "Âge (années)",
                mileage: "Kilométrage",
                cars: "Voitures",
                firstHand: "1ère main",
                secondHand: "2ème main",
                thirdPlus: "3ème+ main",
                unknown: "Inconnu",
                rank: "#",
                car: "Voiture",
                year: "Année",
                fuel: "Carburant",
                transmission: "Transmission",
                type: "Type",
                cvFiscal: "CV Fiscal",
                governorate: "Gouvernorat",
                condition: "État",

                // Price buckets
                under30k: "< 30K",
                range30to50k: "30-50K",
                range50to80k: "50-80K",
                range80to120k: "80-120K",
                range120to200k: "120-200K",
                over200k: "> 200K",

                // Mileage buckets
                under50k: "< 50K km",
                range50to100k: "50-100K km",
                range100to150k: "100-150K km",
                range150to200k: "150-200K km",
                over200kKm: "> 200K km",

                loading: "Chargement des données...",
                errorTitle: "Erreur de Chargement",
                errorHelp: "Veuillez d'abord exécuter le scraper :"
            }
        };

        function t(key) {
            return translations[currentLang][key] || key;
        }

        function setLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('dashboardLang', lang);

            document.getElementById('lang-en').classList.toggle('active', lang === 'en');
            document.getElementById('lang-fr').classList.toggle('active', lang === 'fr');

            document.getElementById('header-title').textContent = t('headerTitle');
            document.getElementById('header-subtitle').textContent = t('headerSubtitle');
            document.querySelector('footer').textContent = t('footerText');

            if (cachedData) {
                destroyAllCharts();
                renderDashboard(cachedData);
            }
        }

        function destroyAllCharts() {
            Object.values(chartInstances).forEach(chart => {
                if (chart && typeof chart.destroy === 'function') {
                    chart.destroy();
                }
            });
            chartInstances = {};
        }

        function initLanguage() {
            document.getElementById('lang-en').classList.toggle('active', currentLang === 'en');
            document.getElementById('lang-fr').classList.toggle('active', currentLang === 'fr');
            document.getElementById('header-title').textContent = t('headerTitle');
            document.getElementById('header-subtitle').textContent = t('headerSubtitle');
            document.querySelector('footer').textContent = t('footerText');
            const loadingEl = document.getElementById('loading-text');
            if (loadingEl) loadingEl.textContent = t('loading');
        }

        // Color palettes
        const colors = {
            blue: '#3b82f6',
            purple: '#8b5cf6',
            green: '#10b981',
            orange: '#f59e0b',
            red: '#ef4444',
            pink: '#ec4899',
            cyan: '#06b6d4',
            yellow: '#eab308',
            indigo: '#6366f1',
            teal: '#14b8a6'
        };

        const colorPalette = [
            colors.blue, colors.purple, colors.green, colors.orange, colors.red,
            colors.pink, colors.cyan, colors.yellow, colors.indigo, colors.teal
        ];

        function isMobile() {
            return window.innerWidth <= 768;
        }

        function legendPosition() {
            return isMobile() ? 'bottom' : 'right';
        }

        function formatPrice(price) {
            return new Intl.NumberFormat('fr-TN').format(price) + ' DT';
        }

        function formatNumber(num) {
            return new Intl.NumberFormat('fr-TN').format(num);
        }

        function formatMileage(km) {
            return new Intl.NumberFormat('fr-TN').format(km) + ' km';
        }

        function getFuelBadge(fuel) {
            if (!fuel) return '<span class="badge badge-default">-</span>';
            const fuelLower = fuel.toLowerCase();
            if (fuelLower.includes('electrique') || fuelLower.includes('électrique')) {
                return `<span class="badge badge-electrique">${fuel}</span>`;
            } else if (fuelLower.includes('hybride')) {
                return `<span class="badge badge-hybride">${fuel}</span>`;
            } else if (fuelLower.includes('diesel')) {
                return `<span class="badge badge-diesel">${fuel}</span>`;
            } else if (fuelLower.includes('essence')) {
                return `<span class="badge badge-essence">${fuel}</span>`;
            }
            return `<span class="badge badge-default">${fuel}</span>`;
        }

        function getTransmissionBadge(trans) {
            if (!trans) return '<span class="badge badge-default">-</span>';
            const transLower = trans.toLowerCase();
            if (transLower.includes('auto')) {
                return `<span class="badge badge-automatique">${trans}</span>`;
            } else if (transLower.includes('manuel') || transLower.includes('manual')) {
                return `<span class="badge badge-manuelle">${trans}</span>`;
            }
            return `<span class="badge badge-default">${trans}</span>`;
        }

        function getBodyTypeBadge(bodyType) {
            if (!bodyType) return '<span class="badge badge-default">-</span>';
            const bodyLower = bodyType.toLowerCase();
            const badgeMap = {
                'suv': 'suv', 'crossover': 'suv', 'berline': 'berline',
                'citadine': 'citadine', 'compacte': 'compacte', 'break': 'break',
                'coupé': 'coupe', 'coupe': 'coupe', 'cabriolet': 'cabriolet',
                'monospace': 'monospace', 'pick-up': 'pick-up', 'pickup': 'pick-up',
                'utilitaire': 'utilitaire'
            };
            for (const [key, badgeClass] of Object.entries(badgeMap)) {
                if (bodyLower.includes(key)) {
                    return `<span class="badge badge-${badgeClass}">${bodyType}</span>`;
                }
            }
            return `<span class="badge badge-default">${bodyType}</span>`;
        }

        function getConditionBadge(condition) {
            if (!condition) return '<span class="badge badge-default">-</span>';
            const condLower = condition.toLowerCase();
            if (condLower.includes('très bon') || condLower.includes('tres bon')) {
                return `<span class="badge badge-condition-tres-bon">${condition}</span>`;
            } else if (condLower.includes('bon')) {
                return `<span class="badge badge-condition-bon">${condition}</span>`;
            }
            return `<span class="badge badge-condition-normal">${condition}</span>`;
        }

        async function loadData() {
            try {
                const response = await fetch('automobile_tn_used_cars.json');
                if (!response.ok) throw new Error('Data file not found');
                const data = await response.json();
                return data;
            } catch (error) {
                throw error;
            }
        }

        function calculateStats(cars) {
            const currentYear = 2026;
            const prices = cars.map(c => c.price_tnd).filter(p => p);
            const mileages = cars.map(c => c.mileage_km).filter(m => m);
            const years = cars.map(c => c.year).filter(y => y);
            const ages = years.map(y => currentYear - y);
            const brands = [...new Set(cars.map(c => c.brand))];

            const fuelTypes = {};
            const bodyTypes = {};
            const transmissions = {};
            const brandCounts = {};
            const ownershipCounts = {};
            const conditionCounts = {};
            const governorateCounts = {};
            const yearCounts = {};
            const equipmentCounts = {};

            cars.forEach(car => {
                // Fuel types
                const fuel = car.fuel_type || 'Unknown';
                fuelTypes[fuel] = (fuelTypes[fuel] || 0) + 1;

                // Body types
                const body = car.body_type || 'Unknown';
                bodyTypes[body] = (bodyTypes[body] || 0) + 1;

                // Transmissions
                const trans = car.transmission || 'Unknown';
                transmissions[trans] = (transmissions[trans] || 0) + 1;

                // Brand counts
                brandCounts[car.brand] = (brandCounts[car.brand] || 0) + 1;

                // Ownership
                const ownership = car.ownership || 'Unknown';
                ownershipCounts[ownership] = (ownershipCounts[ownership] || 0) + 1;

                // Condition
                const condition = car.condition || 'Unknown';
                conditionCounts[condition] = (conditionCounts[condition] || 0) + 1;

                // Governorate
                const gov = car.governorate || 'Unknown';
                governorateCounts[gov] = (governorateCounts[gov] || 0) + 1;

                // Year distribution
                if (car.year) {
                    yearCounts[car.year] = (yearCounts[car.year] || 0) + 1;
                }

                // Equipment counts
                const allEquipment = [
                    ...(car.equipment_safety || []),
                    ...(car.equipment_interior || []),
                    ...(car.equipment_exterior || []),
                    ...(car.equipment_functional || [])
                ];
                allEquipment.forEach(eq => {
                    equipmentCounts[eq] = (equipmentCounts[eq] || 0) + 1;
                });
            });

            return {
                totalCars: cars.length,
                totalBrands: brands.length,
                minPrice: Math.min(...prices),
                maxPrice: Math.max(...prices),
                avgPrice: Math.round(prices.reduce((a, b) => a + b, 0) / prices.length),
                avgMileage: Math.round(mileages.reduce((a, b) => a + b, 0) / mileages.length),
                avgAge: (ages.reduce((a, b) => a + b, 0) / ages.length).toFixed(1),
                prices,
                mileages,
                fuelTypes,
                bodyTypes,
                transmissions,
                brandCounts,
                ownershipCounts,
                conditionCounts,
                governorateCounts,
                yearCounts,
                equipmentCounts
            };
        }

        function renderDashboard(data) {
            cachedData = data;
            const cars = data.cars;
            const stats = calculateStats(cars);

            const content = document.getElementById('content');
            content.innerHTML = `
                <!-- Summary Stats -->
                <div class="stats-grid">
                    <div class="stat-card gradient-1">
                        <h3>${t('totalListings')}</h3>
                        <div class="value">${formatNumber(stats.totalCars)}</div>
                        <div class="subtitle">${t('totalListingsSubtitle')}</div>
                    </div>
                    <div class="stat-card gradient-2">
                        <h3>${t('brands')}</h3>
                        <div class="value">${stats.totalBrands}</div>
                        <div class="subtitle">${t('brandsSubtitle')}</div>
                    </div>
                    <div class="stat-card gradient-3">
                        <h3>${t('averagePrice')}</h3>
                        <div class="value">${formatPrice(stats.avgPrice)}</div>
                        <div class="subtitle">${t('averagePriceSubtitle')}</div>
                    </div>
                    <div class="stat-card gradient-4">
                        <h3>${t('avgMileage')}</h3>
                        <div class="value">${formatMileage(stats.avgMileage)}</div>
                        <div class="subtitle">${t('avgMileageSubtitle')}</div>
                    </div>
                    <div class="stat-card gradient-5">
                        <h3>${t('avgAge')}</h3>
                        <div class="value">${stats.avgAge}</div>
                        <div class="subtitle">${t('avgAgeSubtitle')}</div>
                    </div>
                </div>

                <!-- Charts Grid -->
                <div class="charts-grid">
                    <!-- Price Distribution -->
                    <div class="chart-card">
                        <h2>${t('priceDistribution')}</h2>
                        <div class="chart-container">
                            <canvas id="priceDistChart"></canvas>
                        </div>
                    </div>

                    <!-- Price vs Age Scatter -->
                    <div class="chart-card">
                        <h2>${t('priceVsAge')}</h2>
                        <div class="chart-container">
                            <canvas id="priceAgeChart"></canvas>
                        </div>
                    </div>

                    <!-- Fuel Types -->
                    <div class="chart-card">
                        <h2>${t('fuelTypes')}</h2>
                        <div class="chart-container">
                            <canvas id="fuelChart"></canvas>
                        </div>
                    </div>

                    <!-- Transmission Types -->
                    <div class="chart-card">
                        <h2>${t('transmissionTypes')}</h2>
                        <div class="chart-container">
                            <canvas id="transmissionChart"></canvas>
                        </div>
                    </div>

                    <!-- Body Types -->
                    <div class="chart-card">
                        <h2>${t('bodyTypes')}</h2>
                        <div class="chart-container">
                            <canvas id="bodyChart"></canvas>
                        </div>
                    </div>

                    <!-- Top Brands -->
                    <div class="chart-card">
                        <h2>${t('topBrands')}</h2>
                        <div class="chart-container tall">
                            <canvas id="brandChart"></canvas>
                        </div>
                    </div>

                    <!-- Age Distribution -->
                    <div class="chart-card">
                        <h2>${t('ageDistribution')}</h2>
                        <div class="chart-container">
                            <canvas id="ageChart"></canvas>
                        </div>
                    </div>

                    <!-- Mileage Distribution -->
                    <div class="chart-card">
                        <h2>${t('mileageDistribution')}</h2>
                        <div class="chart-container">
                            <canvas id="mileageChart"></canvas>
                        </div>
                    </div>

                    <!-- Ownership History -->
                    <div class="chart-card">
                        <h2>${t('ownershipHistory')}</h2>
                        <div class="chart-container">
                            <canvas id="ownershipChart"></canvas>
                        </div>
                    </div>

                    <!-- Condition Distribution -->
                    <div class="chart-card">
                        <h2>${t('conditionDistribution')}</h2>
                        <div class="chart-container">
                            <canvas id="conditionChart"></canvas>
                        </div>
                    </div>

                    <!-- Geographic Distribution -->
                    <div class="chart-card">
                        <h2>${t('geographicDistribution')}</h2>
                        <div class="chart-container tall">
                            <canvas id="geoChart"></canvas>
                        </div>
                    </div>

                    <!-- Most Common Equipment -->
                    <div class="chart-card">
                        <h2>${t('commonEquipment')}</h2>
                        <div class="chart-container tall">
                            <canvas id="equipmentChart"></canvas>
                        </div>
                    </div>

                    <!-- Top 10 Most Expensive -->
                    <div class="chart-card">
                        <h2>${t('topExpensive')}</h2>
                        <div class="table-container">
                            <table id="expensiveTable"></table>
                        </div>
                    </div>

                    <!-- Best Deals (Price per KM) -->
                    <div class="chart-card">
                        <h2>${t('bestDeals')}</h2>
                        <div class="table-container">
                            <table id="dealsTable"></table>
                        </div>
                    </div>

                </div>
            `;

            // Render all charts
            renderPriceDistribution(stats);
            renderPriceAgeScatter(cars);
            renderFuelChart(stats);
            renderTransmissionChart(stats);
            renderBodyChart(stats);
            renderBrandChart(stats);
            renderAgeChart(stats);
            renderMileageChart(stats);
            renderOwnershipChart(stats);
            renderConditionChart(stats);
            renderGeoChart(stats);
            renderEquipmentChart(stats);
            renderExpensiveTable(cars);
            renderDealsTable(cars);
        }

        function renderPriceDistribution(stats) {
            const ctx = document.getElementById('priceDistChart').getContext('2d');

            const buckets = [
                { label: t('under30k'), min: 0, max: 30000 },
                { label: t('range30to50k'), min: 30000, max: 50000 },
                { label: t('range50to80k'), min: 50000, max: 80000 },
                { label: t('range80to120k'), min: 80000, max: 120000 },
                { label: t('range120to200k'), min: 120000, max: 200000 },
                { label: t('over200k'), min: 200000, max: Infinity }
            ];

            const counts = buckets.map(b =>
                stats.prices.filter(p => p >= b.min && p < b.max).length
            );

            chartInstances.priceDist = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: buckets.map(b => b.label),
                    datasets: [{
                        label: t('numberOfCars'),
                        data: counts,
                        backgroundColor: colorPalette,
                        borderRadius: 8,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        function renderPriceAgeScatter(cars) {
            const ctx = document.getElementById('priceAgeChart').getContext('2d');
            const currentYear = 2026;

            const data = cars
                .filter(c => c.year && c.price_tnd)
                .map(c => ({
                    x: currentYear - c.year,
                    y: c.price_tnd,
                    label: c.full_name
                }));

            chartInstances.priceAge = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: t('priceVsAge'),
                        data: data,
                        backgroundColor: colors.purple + '80',
                        borderColor: colors.purple,
                        pointRadius: 6,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: ctx => `${ctx.raw.label}: ${formatPrice(ctx.raw.y)} (${ctx.raw.x} ${currentLang === 'fr' ? 'ans' : 'yrs'})`
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: t('age') },
                            grid: { color: 'rgba(255,255,255,0.05)' }
                        },
                        y: {
                            title: { display: true, text: t('price') },
                            ticks: { callback: v => (v / 1000) + 'K' },
                            grid: { color: 'rgba(255,255,255,0.05)' }
                        }
                    }
                }
            });
        }

        function renderFuelChart(stats) {
            const ctx = document.getElementById('fuelChart').getContext('2d');
            const sorted = Object.entries(stats.fuelTypes).sort((a, b) => b[1] - a[1]);

            chartInstances.fuel = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: sorted.map(s => s[0]),
                    datasets: [{
                        data: sorted.map(s => s[1]),
                        backgroundColor: colorPalette.slice(0, sorted.length),
                        borderWidth: 0,
                        spacing: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: legendPosition(), labels: { padding: 15, usePointStyle: true } }
                    },
                    cutout: '60%'
                }
            });
        }

        function renderTransmissionChart(stats) {
            const ctx = document.getElementById('transmissionChart').getContext('2d');
            const labels = Object.keys(stats.transmissions);
            const data = Object.values(stats.transmissions);

            chartInstances.transmission = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [colors.blue, colors.orange, colors.purple],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: legendPosition(), labels: { padding: 15, usePointStyle: true } }
                    }
                }
            });
        }

        function renderBodyChart(stats) {
            const ctx = document.getElementById('bodyChart').getContext('2d');
            const sorted = Object.entries(stats.bodyTypes).sort((a, b) => b[1] - a[1]);

            chartInstances.body = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: sorted.map(s => s[0]),
                    datasets: [{
                        data: sorted.map(s => s[1]),
                        backgroundColor: colorPalette.slice(0, sorted.length),
                        borderWidth: 0,
                        spacing: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: legendPosition(), labels: { padding: 15, usePointStyle: true } }
                    },
                    cutout: '60%'
                }
            });
        }

        function renderBrandChart(stats) {
            const ctx = document.getElementById('brandChart').getContext('2d');
            const sorted = Object.entries(stats.brandCounts).sort((a, b) => b[1] - a[1]).slice(0, 15);

            chartInstances.brand = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sorted.map(s => s[0]),
                    datasets: [{
                        label: t('cars'),
                        data: sorted.map(s => s[1]),
                        backgroundColor: colorPalette,
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' } },
                        y: { grid: { display: false } }
                    }
                }
            });
        }

        function renderAgeChart(stats) {
            const ctx = document.getElementById('ageChart').getContext('2d');
            const sortedYears = Object.entries(stats.yearCounts).sort((a, b) => a[0] - b[0]);

            chartInstances.age = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedYears.map(s => s[0]),
                    datasets: [{
                        label: t('cars'),
                        data: sortedYears.map(s => s[1]),
                        backgroundColor: colors.cyan,
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        function renderMileageChart(stats) {
            const ctx = document.getElementById('mileageChart').getContext('2d');

            const buckets = [
                { label: t('under50k'), min: 0, max: 50000 },
                { label: t('range50to100k'), min: 50000, max: 100000 },
                { label: t('range100to150k'), min: 100000, max: 150000 },
                { label: t('range150to200k'), min: 150000, max: 200000 },
                { label: t('over200kKm'), min: 200000, max: Infinity }
            ];

            const counts = buckets.map(b =>
                stats.mileages.filter(m => m >= b.min && m < b.max).length
            );

            chartInstances.mileage = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: buckets.map(b => b.label),
                    datasets: [{
                        label: t('cars'),
                        data: counts,
                        backgroundColor: colors.orange,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        function renderOwnershipChart(stats) {
            const ctx = document.getElementById('ownershipChart').getContext('2d');

            // Normalize ownership labels
            const ownershipMap = {};
            Object.entries(stats.ownershipCounts).forEach(([key, value]) => {
                const keyLower = key.toLowerCase();
                if (keyLower.includes('1') || keyLower.includes('première') || keyLower.includes('premiere')) {
                    ownershipMap[t('firstHand')] = (ownershipMap[t('firstHand')] || 0) + value;
                } else if (keyLower.includes('2') || keyLower.includes('deuxième') || keyLower.includes('deuxieme')) {
                    ownershipMap[t('secondHand')] = (ownershipMap[t('secondHand')] || 0) + value;
                } else if (keyLower.includes('3') || keyLower.includes('troisième') || keyLower.includes('troisieme') || keyLower.includes('+')) {
                    ownershipMap[t('thirdPlus')] = (ownershipMap[t('thirdPlus')] || 0) + value;
                } else if (key !== 'Unknown') {
                    ownershipMap[key] = value;
                } else {
                    ownershipMap[t('unknown')] = (ownershipMap[t('unknown')] || 0) + value;
                }
            });

            const sorted = Object.entries(ownershipMap).sort((a, b) => b[1] - a[1]);

            chartInstances.ownership = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: sorted.map(s => s[0]),
                    datasets: [{
                        data: sorted.map(s => s[1]),
                        backgroundColor: [colors.green, colors.blue, colors.orange, colors.purple],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: legendPosition(), labels: { padding: 15, usePointStyle: true } }
                    }
                }
            });
        }

        function renderConditionChart(stats) {
            const ctx = document.getElementById('conditionChart').getContext('2d');
            const sorted = Object.entries(stats.conditionCounts)
                .filter(([k, _]) => k !== 'Unknown')
                .sort((a, b) => b[1] - a[1]);

            chartInstances.condition = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: sorted.map(s => s[0]),
                    datasets: [{
                        data: sorted.map(s => s[1]),
                        backgroundColor: [colors.green, colors.blue, colors.orange],
                        borderWidth: 0,
                        spacing: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: legendPosition(), labels: { padding: 15, usePointStyle: true } }
                    },
                    cutout: '60%'
                }
            });
        }

        function renderGeoChart(stats) {
            const ctx = document.getElementById('geoChart').getContext('2d');
            const sorted = Object.entries(stats.governorateCounts)
                .filter(([k, _]) => k !== 'Unknown')
                .sort((a, b) => b[1] - a[1])
                .slice(0, 15);

            chartInstances.geo = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sorted.map(s => s[0]),
                    datasets: [{
                        label: t('cars'),
                        data: sorted.map(s => s[1]),
                        backgroundColor: colorPalette,
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' } },
                        y: { grid: { display: false } }
                    }
                }
            });
        }

        function renderEquipmentChart(stats) {
            const ctx = document.getElementById('equipmentChart').getContext('2d');
            const sorted = Object.entries(stats.equipmentCounts).sort((a, b) => b[1] - a[1]).slice(0, 10);

            chartInstances.equipment = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sorted.map(s => s[0]),
                    datasets: [{
                        label: t('cars'),
                        data: sorted.map(s => s[1]),
                        backgroundColor: colorPalette,
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' } },
                        y: { grid: { display: false } }
                    }
                }
            });
        }

        function renderExpensiveTable(cars) {
            const sorted = [...cars].sort((a, b) => (b.price_tnd || 0) - (a.price_tnd || 0)).slice(0, 10);
            const table = document.getElementById('expensiveTable');

            table.innerHTML = `
                <thead>
                    <tr>
                        <th>${t('rank')}</th>
                        <th>${t('car')}</th>
                        <th>${t('price')}</th>
                        <th>${t('year')}</th>
                        <th>${t('mileage')}</th>
                        <th>${t('fuel')}</th>
                    </tr>
                </thead>
                <tbody>
                    ${sorted.map((car, i) => `
                        <tr>
                            <td>${i + 1}</td>
                            <td><strong>${car.full_name}</strong></td>
                            <td class="price">${formatPrice(car.price_tnd)}</td>
                            <td class="year">${car.year || '-'}</td>
                            <td class="mileage">${car.mileage_km ? formatMileage(car.mileage_km) : '-'}</td>
                            <td>${getFuelBadge(car.fuel_type)}</td>
                        </tr>
                    `).join('')}
                </tbody>
            `;
        }

        function renderDealsTable(cars) {
            // Newest cars at best prices: sort by year (newest first), then by price (lowest)
            const newestDeals = cars
                .filter(c => c.price_tnd && c.year && c.mileage_km)
                .sort((a, b) => {
                    if (b.year !== a.year) return b.year - a.year;
                    return a.price_tnd - b.price_tnd;
                })
                .slice(0, 10);

            const table = document.getElementById('dealsTable');

            table.innerHTML = `
                <thead>
                    <tr>
                        <th>${t('rank')}</th>
                        <th>${t('car')}</th>
                        <th>${t('year')}</th>
                        <th>${t('price')}</th>
                        <th>${t('mileage')}</th>
                        <th>${t('condition')}</th>
                    </tr>
                </thead>
                <tbody>
                    ${newestDeals.map((car, i) => `
                        <tr>
                            <td>${i + 1}</td>
                            <td><strong>${car.full_name}</strong></td>
                            <td class="year">${car.year}</td>
                            <td class="price">${formatPrice(car.price_tnd)}</td>
                            <td class="mileage">${car.mileage_km ? formatMileage(car.mileage_km) : '-'}</td>
                            <td>${getConditionBadge(car.condition)}</td>
                        </tr>
                    `).join('')}
                </tbody>
            `;
        }

        // Initialize dashboard
        initLanguage();
        loadData()
            .then(data => renderDashboard(data))
            .catch(error => {
                document.getElementById('content').innerHTML = `
                    <div class="error">
                        <h3>${t('errorTitle')}</h3>
                        <p>${error.message}</p>
                        <p style="margin-top:10px;color:#94a3b8;">
                            ${t('errorHelp')} <code>python used_cars_scraper.py</code>
                        </p>
                    </div>
                `;
            });
    </script>
</body>
</html>
